<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PetHealth Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--primary:#0d6efd;--accent:#0b5ed7;--bg:#f8fbff}
    body{background:linear-gradient(180deg,#f6fbff 0%,#ffffff 40%);color:#0b2a3a}
    .brand{color:var(--accent)}
    .card{border-radius:12px}
    .spinner-overlay{position:fixed;inset:0;background:rgba(255,255,255,0.6);display:flex;align-items:center;justify-content:center;z-index:1050}
    .mode-badge{font-size:.85rem}
    pre code{white-space:pre-wrap}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand brand fw-bold" href="#">PetHealth Manager</a>
      <span class="text-muted">Análisis CSV veterinario con Gemini</span>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row g-4">
      <div class="col-lg-5">
        <div class="card p-4 shadow-sm">
          <h5 class="mb-3">Cargar CSV</h5>
          <div class="mb-3">
            <input id="fileInput" type="file" accept="text/csv" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Modo de análisis</label>
            <select id="modeSelect" class="form-select">
              <option value="mode1">Sanitario y Epidemiológico</option>
              <option value="mode2">Riesgo de Inventario</option>
              <option value="mode3">Oportunidades de Negocio</option>
            </select>
          </div>
          <div class="d-flex gap-2">
            <button id="analyzeBtn" class="btn btn-primary w-100">Analizar</button>
            <button id="clearBtn" class="btn btn-outline-secondary">Limpiar</button>
          </div>
          <div class="mt-3 text-muted small">API Key integrada en la app. Esta página es estática y lista para GitHub Pages.</div>
        </div>
        <div class="mt-3 text-center text-muted small">Diseño profesional médico — blanco y azules</div>
      </div>

      <div class="col-lg-7">
        <div class="card p-3 shadow-sm" id="outputCard">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Resultado</h5>
            <span class="badge bg-info mode-badge" id="modeBadge">Sanitario y Epidemiológico</span>
          </div>
          <div id="output" class="pt-2">
            <div class="text-muted">Cargue un CSV y presione <strong>Analizar</strong>.</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="spinner" class="spinner-overlay" style="display:none">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem"></div>
      <div class="mt-2">Procesando con Gemini…</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const API_KEY = "AIzaSyA0zIVtlxIx9ajwKQuXVkrSlFpikBzOz0A";
    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const fileInput = document.getElementById('fileInput');
    const modeSelect = document.getElementById('modeSelect');
    const output = document.getElementById('output');
    const spinner = document.getElementById('spinner');
    const modeBadge = document.getElementById('modeBadge');

    modeSelect.addEventListener('change', ()=>{
      const txt = modeSelect.value === 'mode1' ? 'Sanitario y Epidemiológico' : modeSelect.value === 'mode2' ? 'Riesgo de Inventario' : 'Oportunidades de Negocio';
      modeBadge.textContent = txt;
    });

    clearBtn.addEventListener('click', ()=>{
      fileInput.value = '';
      output.innerHTML = '<div class="text-muted">Cargue un CSV y presione <strong>Analizar</strong>.</div>';
    });

    analyzeBtn.addEventListener('click', async ()=>{
      if(!fileInput.files || fileInput.files.length===0){
        alert('Seleccione un archivo CSV para analizar.');
        return;
      }
      const file = fileInput.files[0];
      const text = await file.text();
      const csvText = text.trim();
      const mode = modeSelect.value;
      const prompt = buildPrompt(mode, csvText);
      spinner.style.display = 'flex';
      output.innerHTML = '';
      try{
        const res = await callGemini(prompt);
        const md = extractTextFromResponse(res) || 'No se recibió respuesta de la API.';
        const html = marked.parse(md);
        output.innerHTML = html;
      }catch(e){
        output.innerHTML = '<div class="text-danger">Error al llamar a la API: '+String(e)+'</div>';
      }finally{
        spinner.style.display = 'none';
      }
    });

    function buildPrompt(mode, csvText){
      if(mode === 'mode1'){
        return '"Analiza este CSV veterinario.[cite: 34]. [cite_start]Genera un Resumen Ejecutivo de salud[cite: 53]. [cite_start]Identifica brotes epidémicos basados en frecuencia (ej. Parvovirus)[cite: 54]. [cite_start]Da recomendaciones preventivas urgentes (Aislamiento, EPP)[cite: 55]. Formato Markdown."\n\nCSV_DATA:\n'+csvText;
      }
      if(mode === 'mode2'){
        return '"Analiza este CSV como Gerente de Inventario[cite: 92]. [cite_start]Identifica los 5 productos con menor venta o próximos a vencer[cite: 94]. [cite_start]Genera una tabla con SKU, Nombre, Cantidad [cite: 95] [cite_start]y una recomendación estratégica de 1-2 líneas por producto[cite: 97]."\n\nCSV_DATA:\n'+csvText;
      }
      return '"Analiza este CSV como Analista de Negocios[cite: 138]. [cite_start]Indica la categoría de mayor crecimiento[cite: 141]. [cite_start]Sugiere 2 oportunidades de \'venta cruzada\' o combos basados en productos vendidos juntos[cite: 142]."\n\nCSV_DATA:\n'+csvText;
    }

    async function callGemini(prompt){
      const url = 'https://generativeai.googleapis.com/v1/models/gemini-1.5-flash:generateText?key='+encodeURIComponent(API_KEY);
      const body = {
        prompt: {text: prompt},
        maxOutputTokens: 1024,
        temperature: 0.2
      };
      const r = await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok){
        const txt = await r.text();
        throw new Error('HTTP '+r.status+': '+txt);
      }
      return await r.json();
    }

    function extractTextFromResponse(json){
      if(!json) return null;
      if(json.candidates && Array.isArray(json.candidates) && json.candidates.length>0){
        if(typeof json.candidates[0].content === 'string') return json.candidates[0].content;
        if(typeof json.candidates[0].output === 'string') return json.candidates[0].output;
      }
      if(json.output && Array.isArray(json.output) && json.output.length>0){
        const o = json.output[0];
        if(o.content) return typeof o.content === 'string' ? o.content : (Array.isArray(o.content) ? o.content.map(c=>c.text||c).join('\n') : JSON.stringify(o.content));
        if(o.text) return o.text;
      }
      if(json.text) return json.text;
      if(json.generatedText) return json.generatedText;
      return JSON.stringify(json);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

